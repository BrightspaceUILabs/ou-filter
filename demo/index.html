<!DOCTYPE html>
<html lang="en" data-timezone='{"name":"Canada - Toronto","identifier":"America/Chicago"}'>
<head>
		<link rel="stylesheet" href="/node_modules/@brightspace-ui/core/components/demo/styles.css" type="text/css">
		<script type="module" src="/node_modules/@brightspace-ui/core/components/demo/demo-page.js"></script>
		<script type="module">
			/* eslint-disable no-console */
			import { action, decorate, observable } from 'mobx';
			import { COURSE_OFFERING, Tree } from '../tree-filter';
			import { css, html } from 'lit-element/lit-element.js';
			import { MobxLitElement } from '@adobe/lit-mobx';
			import { OuFilterDataManager } from '../ou-filter';

			const orgUnitChildrenCache = new Map();
			function fetchCachedChildren() {
				return orgUnitChildrenCache;
			}

			class DemoDataManager extends OuFilterDataManager {

				constructor() {
					super();
					this._orgUnitTree = new Tree({});
				}

				loadData() {
					const lastSearchResults = null;
					const semesterTypeId = 25;
					const orgUnits = [
						{ Id: 1, Name: 'Course 1', Type: 3, Parents: [3, 4], IsActive: false },
						{ Id: 2, Name: 'Course 2', Type: 3, Parents: [3, 10], IsActive: true },
						{ Id: 6, Name: 'Course 3 has a surprisingly long name, but nonetheless this kind of thing is bound to happen sometimes and we do need to design for it. Is that not so?', Type: 3, Parents: [7, 4], IsActive: true },
						{ Id: 8, Name: 'ZCourse 4', Type: 3, Parents: [5], IsActive: false },
						{ Id: 3, Name: 'Department 1', Type: 2, Parents: [5], IsActive: false },
						{ Id: 7, Name: 'Department 2 has a longer name', Type: 2, Parents: [5], IsActive: false },
						{ Id: 4, Name: 'Semester 1', Type: 25, Parents: [6606], IsActive: false },
						{ Id: 10, Name: 'Semester 2', Type: 25, Parents: [6606], IsActive: false },
						{ Id: 5, Name: 'Faculty 1', Type: 7, Parents: [6606], IsActive: false },
						{ Id: 9, Name: 'Faculty 2', Type: 7, Parents: [6606, 10], IsActive: false },
						{ Id: 6606, Name: 'Dev', Type: 1, Parents: [0], IsActive: false }
					];
					const isOrgUnitsTruncated = true;

					this._orgUnitTree = new Tree({
						// add in any nodes from the most recent search; otherwise
						// the search will blink out and come back, and also drop any "load more" results
						nodes: lastSearchResults ? [...orgUnits, ...lastSearchResults] : orgUnits,
						leafTypes: [COURSE_OFFERING],
						invisibleTypes: [semesterTypeId],
						selectedIds: [1],
						ancestorIds: [],
						oldTree: this.orgUnitTree,
						isDynamic: isOrgUnitsTruncated,
						// preload the tree with any children queries we've already run: otherwise parts of the
						// tree blink out and then come back as they are loaded again
						extraChildren: isOrgUnitsTruncated ?
							fetchCachedChildren() || new Map() :
							null
					});
				}

				get orgUnitTree() {
					return this._orgUnitTree;
				}

				// the method called only when Tree.isDynamic === true
				async fetchRelevantChildren(id, bookmark) {
					console.log(`fetchRelevantChildren ${id}, ${bookmark}`);

					if (id !== 9 || bookmark === 'orgUnit-9') {
						// returns no children responce
						return await super.fetchRelevantChildren(id, bookmark);
					}

					// imitate more children for node 9: Faculty 2
					const results = { PagingInfo: { HasMoreItems: false, Bookmark: 'orgUnit-9' }, Items: [
						{ Id: 20, Name: 'Department 3', Type: 2, Parents: [9], IsActive: false }
					] };

					// example of handling cache
					if (!orgUnitChildrenCache.has(id)) {
						orgUnitChildrenCache.set(id, results);
					} else {
						const cached = orgUnitChildrenCache.get(id);
						cached.PagingInfo = results.PagingInfo;
						cached.Items.push(...results.Items);
					}

					// return result in 2 sec to show loading spinner
					return await new Promise(resolve => setTimeout(() => resolve(results), 2000));
				}

				// the method called only when Tree.isDynamic === true
				async orgUnitSearch(searchString, bookmark) {
					console.log(`orgUnitSearch ${searchString}, ${bookmark}`);

					return await super.orgUnitSearch(searchString, bookmark);
				}
			}

			decorate(DemoDataManager, {
				_orgUnitTree: observable,
				loadData: action
			});

			class DemoPage extends MobxLitElement {

				static get styles() {
					return [
						css`
							:host {
								display: inline-block;
							}
							div {
								padding: 30px;
							}
						`
					];
				}

				constructor() {
					super();
					this.dataManager = new DemoDataManager();
				}

				firstUpdated() {
					this.dataManager.loadData();
				}

				render() {
					return html`
						<div>
							<d2l-labs-ou-filter
								.dataManager=${this.dataManager}
								@d2l-labs-ou-filter-change="${this._orgUnitFilterChange}"
							></d2l-labs-ou-filter>
						</div>
					`;
				}

				_orgUnitFilterChange(event) {
					event.stopPropagation();
					console.log(event.target.selected);
				}
			}

			customElements.define('d2l-labs-demo-page', DemoPage);
		</script>
		<title>d2l-labs-ou-filter</title>
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<meta charset="UTF-8">
	</head>
	<style>
		html, body {
			min-height: 100%;
		}
		body {
			background-color: white;
		}
	</style>
	<body>
		<d2l-labs-demo-page></d2l-labs-demo-page>
	</body>
</html>
